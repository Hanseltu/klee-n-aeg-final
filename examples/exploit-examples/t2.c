#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "klee/klee.h"
struct Type1 {char data [8];};
struct Type2 {
    int status;
    int* ptr;
};
int (*handler1)(const int *);
int (*handler2)(int);
int (*handler)(const int*);
int goodFunc(const int* var){printf("/////This is a Good function\n");return 0;}
int badFunc(const int* var){printf("/////This is a Evil function\n");return 0;}
int ggoodFunc(int a){printf("/////This is a Good function\n");return 0;}
int bbadFunc(int a){printf("/////This is a Evil function\n");return 0;}

int global_a;
int (*ppp)(const int*);

struct {struct Type1* obj1; struct Type2* obj2;} gvar = {};
int main(int argc, char* argv[]){
    gvar.obj1 = (struct Type1*)malloc(sizeof(struct Type1));
    gvar.obj2 = (struct Type2*)malloc(sizeof(struct Type2));
    int res;
    char input[0x30];
    klee_make_symbolic(input, 0x30, "input");
    memcpy (&gvar.obj1->data, input, 0x30);

    printf ("addr of handler: %p. \n", &handler);
    printf ("addr of handler1: %p. \n", &handler1);
    //printf ("addr of goodFunc: %p. \n", &goodFunc);
    printf ("addr of badFunc: %p. \n", &bbadFunc);

    //printf ("size of obj1:%lx, size of obj2: %lx. \n", sizeof(gvar.obj1), sizeof(gvar.obj2));
    //printf ("addr of gvar.obj1: %p, addr of obj2: %p. \n", gvar.obj1, gvar.obj2);
    //printf ("addr of gvar.obj1->data: %p, addr of obj2->status: %p. %p. \n", &gvar.obj1->data, &gvar.obj2->status, &gvar.obj2->ptr);
    //read(0, &gvar.obj1->data, 0x30);
    handler = goodFunc; //Here we should call a Good function
    handler1 = goodFunc; //Here we should call a Good function
    handler2 = ggoodFunc; //Here we should call a Good function
    if(gvar.obj2->status)
    {
        printf ("crashing path is taken. \n");
        res = *gvar.obj2->ptr;
    }
    else
    {
        printf ("..........exploiting path is taken. \n");
        //*gvar.obj2->ptr = &bbadFunc; // But we modify it (e.g., to badFunc)
        *gvar.obj2->ptr = (unsigned long long)0x5555555548c6; // But we modify it (e.g., to badFunc)
        int a  = (unsigned long long)0x5555555548c5; // But we modify it (e.g., to badFunc)
        printf("address of a = %p\n", &a);
        /*
        //int a = 100;
        int b = a + 100;
        a = b;
        //handler = 100; //Done
        //handler = a  + 100 - 900 + 1000;
        handler = b - 100 + 1000;

        handler = handler + 100;

        int (*p1)(const int*) = handler;
        p1 = b + 400;
        p1(gvar.obj2->ptr);

        int (*p2)(const int*) = handler + 100;
        p2 = b + 600;
        p2(gvar.obj2->ptr);

        handler2 = (unsigned long long)a+1;
        */
    }
    //printf("Curent address of FP :%p\n", handler);
    printf("Before executing indirect call  ... \n");
    //handler1(gvar.obj2->ptr);
    handler2(0);
    if (gvar.obj2->status){
        printf("another 1st path\n");
    }else {
        printf("another 2nd path\n");
    }
    return res;
}

